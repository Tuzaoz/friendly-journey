import express from 'express';

import { PrismaClient } from '@prisma/client';
import dotenv from 'dotenv';
import path from 'path';
import { openai, twilioClient, visionClient } from './config';
import { downloadFile } from './utils/fileOperations';
import {
  analyzeMessageIntent,
  executeQuery,
} from './utils/generatePrismaQuery';
import {
  extractTextFromPDF,
  OCRProcessingError,
  processOCRText,
} from './utils/textProcessing';

dotenv.config({ path: path.resolve(__dirname, '..', '.env') });
export const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
});
const app = express();
app.use(express.urlencoded({ extended: true }));
app.use(express.json());
const port = process.env.PORT || 3000;

function extractNumber(whatsAppText: string) {
  const plusIndex = whatsAppText.indexOf('+');
  return whatsAppText.substring(plusIndex, whatsAppText.length);
}

async function generateNaturalResponse(
  result: any,
  question: string,
  searchTerm?: string,
) {
  const completion = await openai.chat.completions.create({
    model: 'gpt-3.5-turbo',
    messages: [
      {
        role: 'system',
        content: `Voc√™ √© um assistente financeiro especializado em traduzir dados brutos em respostas naturais e amig√°veis. Siga estas regras:

1. **Formata√ß√£o Humanizada:**
   - Valores monet√°rios: Sempre formate como "R$ X,XX"
   - Datas: Use "dia X de [m√™s] de YYYY" (ex: 15 de mar√ßo de 2023)
   - Listas: Destacar 3-5 itens principais quando relevante

2. **Elementos Obrigat√≥rios:**
   - Emojis tem√°ticos no in√≠cio da resposta
   - Men√ß√£o ao per√≠odo analisado quando aplic√°vel
   - Compara√ß√£o percentual com per√≠odos anteriores (se dados dispon√≠veis)
   - Dica de economia relacionada √† pergunta

3. **Proibi√ß√µes Estritas:**
   - ‚ùå Termos t√©cnicos: "query", "join", "aggregate", "database"
   - ‚ùå Nota√ß√£o cient√≠fica/c√≥digos
   - ‚ùå Refer√™ncias √† estrutura de dados

4. **Tom e Estilo:**
   - Coloquial mas profissional (n√≠vel m√©dio de formalidade)
   - Frases curtas (m√°x. 15 palavras)
   - Uso de met√°foras financeiras cotidianas

Exemplo de resposta ruim ‚ùå:
"O aggregate result da query foi 152.30 na sum do amount"

Exemplo de resposta boa ‚úÖ:
"üç∫ Nas suas √∫ltimas compras, voc√™ gastou R$ 152,30 com bebidas. Isso equivale a cerca de 12% do seu or√ßamento mensal para alimenta√ß√£o. Que tal experimentar marcas locais na pr√≥xima vez? üòä"

Formato desejado:
[Emoji] [Introdu√ß√£o contextual] [Valor principal] [Detalhe relevante] [Dica ou curiosidade] [Emoji final]`,
      },
      {
        role: 'user',
        content: `Dados brutos: ${JSON.stringify(result)}
Pergunta original: "${question}"
Termo buscado: ${searchTerm || 'N/A'}
---
Gerar resposta usando: 
- Moeda: BRL 
- Per√≠odo: √∫ltimo m√™s 
- Categorias relacionadas: alimenta√ß√£o, transporte, lazer`,
      },
    ],
    temperature: 0.3,
    max_tokens: 150,
  });

  return completion.choices[0].message.content;
}

app.post('/webhook', async (req, res) => {
  const userPhone = req.body?.From;
  const mediaUrls = [];
  const mediaTypes = [];

  // Coletar todas as m√≠dias enviadas
  let mediaCount = 0;
  while (req.body[`MediaUrl${mediaCount}`]) {
    mediaUrls.push(req.body[`MediaUrl${mediaCount}`]);
    mediaTypes.push(req.body[`MediaContentType${mediaCount}`]);
    mediaCount++;
  }

  const hasMedia = mediaUrls.length > 0;
  const messageText = req.body?.Body || '';
  let responseMessage;

  try {
    const messageAnalysis = await analyzeMessageIntent(messageText, hasMedia);

    if (messageAnalysis.type === 'query') {
      const user = await prisma.user.findUnique({
        where: { phoneNumber: extractNumber(userPhone) },
      });

      if (!user) {
        throw new Error('Usu√°rio n√£o encontrado');
      }
      const response = await executeQuery(messageAnalysis, user.id);
      responseMessage = await generateNaturalResponse(
        JSON.stringify(response),
        messageText,
        messageAnalysis.sqlQuery,
      );
      await twilioClient.messages.create({
        body: responseMessage || 'Sem resposta',
        from: process.env.TWILIO_PHONE_NUMBER!,
        to: userPhone,
      });

      res.status(200).send('OK');
    } else {
      if (mediaUrls.length > 0) {
        const processedDocuments = [];

        // Processar cada m√≠dia sequencialmente
        for (const [index, mediaUrl] of mediaUrls.entries()) {
          const mediaType = mediaTypes[index];

          // 1. Download do arquivo
          const fileBuffer = await downloadFile(mediaUrl);

          // 2. Extra√ß√£o de texto
          let extractedText = '';
          if (mediaType === 'application/pdf') {
            extractedText = await extractTextFromPDF(fileBuffer);
          } else {
            const [visionResult] = await visionClient.textDetection(fileBuffer);
            extractedText = visionResult.fullTextAnnotation?.text || '';
          }

          // 3. Processamento com OpenAI
          const analysisResult = await processOCRText(extractedText);

          // 4. Encontrar ou criar usu√°rio
          const user = await prisma.user.upsert({
            where: { phoneNumber: extractNumber(userPhone) },
            create: { phoneNumber: extractNumber(userPhone) },
            update: {},
          });

          // 5. Salvar dados no banco
          const savedData = await prisma.$transaction(async (tx) => {
            // Salvar documento
            const document = await tx.document.create({
              data: {
                user: { connect: { id: user.id } },
                originalFilename: mediaUrl.split('/').pop() || 'documento',
                storageUrl: mediaUrl,
                documentType:
                  mediaType === 'application/pdf' ? 'pdf_text' : 'image',
                extractedText: extractedText.substring(0, 10000), // Limite de 10k caracteres
                metadata: analysisResult.document.metadata,
              },
            });

            // Salvar despesa principal
            const expense = await tx.expense.create({
              data: {
                user: { connect: { id: user.id } },
                document: { connect: { id: document.id } },
                amount: analysisResult.expense.amount,
                expenseDate: analysisResult.expense.date,
                category: analysisResult.expense.category
                  ? {
                      connectOrCreate: {
                        where: {
                          categoryName: analysisResult.expense.category,
                        },
                        create: {
                          categoryName: analysisResult.expense.category,
                          description:
                            'Criado automaticamente via an√°lise de documento',
                        },
                      },
                    }
                  : undefined,
                confidenceScore: analysisResult.expense.confidence,
                isItemized: analysisResult.items.length > 0,
              },
            });

            // Salvar itens se existirem
            let savedItems = [];
            if (analysisResult.items.length > 0) {
              savedItems = await Promise.all(
                analysisResult.items.map((item: any) =>
                  tx.expenseItem.create({
                    data: {
                      expense: { connect: { id: expense.id } },
                      description: item.description,
                      quantity: item.quantity,
                      unitPrice: item.unitPrice,
                      totalAmount: item.quantity * item.unitPrice,
                      category: item.category
                        ? {
                            connectOrCreate: {
                              where: { categoryName: item.category },
                              create: {
                                categoryName: item.category,
                                description:
                                  'Criado automaticamente via item de documento',
                              },
                            },
                          }
                        : undefined,
                    },
                  }),
                ),
              );
            }

            return { document, expense, items: savedItems };
          });

          processedDocuments.push({
            type: mediaType.includes('pdf') ? 'PDF' : 'Imagem',
            amount: savedData.expense.amount,
            date: savedData.expense.expenseDate,
            itemsCount: savedData.items.length,
          });
        }

        // 6. Montar resposta consolidada
        responseMessage = `üìä An√°lise de ${processedDocuments.length} documentos conclu√≠da!\n\n`;
        responseMessage += processedDocuments
          .map(
            (doc, idx) =>
              `Documento ${idx + 1} (${doc.type}):\n` +
              `‚Ä¢ Valor: R$${doc.amount.toFixed(2)}\n` +
              `‚Ä¢ Data: ${doc.date.toLocaleDateString('pt-BR')}\n` +
              `‚Ä¢ Itens detectados: ${doc.itemsCount}`,
          )
          .join('\n\n');
      } else {
        responseMessage =
          '‚ùå Nenhum arquivo detectado. Envie imagens ou PDFs para an√°lise';
      }

      // Enviar resposta via Twilio
      await twilioClient.messages.create({
        body: responseMessage,
        from: process.env.TWILIO_PHONE_NUMBER!,
        to: userPhone,
      });

      res.status(200).send('OK');
    }
  } catch (error) {
    console.error('Erro no processamento:', error);

    // Enviar mensagem de erro espec√≠fica
    const errorMessage =
      error instanceof OCRProcessingError
        ? '‚ùå N√£o consegui entender este documento. Poderia enviar em outra qualidade?'
        : '‚ö†Ô∏è Ocorreu um erro inesperado. Nossa equipe j√° foi notificada.';

    await twilioClient.messages.create({
      body: errorMessage,
      from: process.env.TWILIO_PHONE_NUMBER!,
      to: userPhone,
    });

    res.status(500).send('Erro interno');
  }
});

app.listen(port, () => {
  console.log(`Servidor rodando em http://localhost:${port}`);
});
